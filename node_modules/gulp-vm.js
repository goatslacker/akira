module.exports = gulpVm

// XXX publish this

var dune2 = require('dune2')
var fs = require('fs')
var gutil = require('gulp-util')
var path = require('path')
var through = require('through2')

var PluginError = gutil.PluginError

const PLUGIN_NAME = 'gulp-vm'

function gulpVm(f) {
  return through.obj(function (file, encoding, callback) {
    if (file.isNull()) {
      return callback(null, file)
    }

    if (file.isStream()) {
      return callback(new PluginError(PLUGIN_NAME, 'Streaming not supported', {
        fileName: file.path,
        showStack: false
      }))
    }

    if (file.isBuffer()) {
      file.contents = new Buffer(f(dune2.string(String(file.contents), file.path)))
    }

    this.push(file)

    return callback()
  })
}
